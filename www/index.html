<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <style>
            html, body, div, canvas {
                margin: 0;
                padding: 0;
                overflow: hidden;
            }
            canvas {
                background-color: gray;
            }
        </style>
    </head>
    <body>
        <script src="js/shared.js"></script>
        <script>
            var player = null;
            var fighters = [];
            var level = null;
            var areas = [];
            var levelAreas = null;

            var canvas = document.createElement("canvas");
            canvas.style.backgroundColor = "#f7f4f1";
            document.body.onresize = function(){
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            document.body.onresize();
            document.body.appendChild(canvas);
            var ctx = canvas.getContext('2d');

            var off = document.createElement('canvas');
            var offctx = null;
            var imagedata = null;
            var pixels = null;

            var ws = new WebSocket((location.host.match(/^localhost:\d+$/) ? 'ws://' : 'wss://') + location.host);
            ws.onopen = function() {
                var vel = {
                    x: 0,
                    y: 0
                };
                document.body.onmousemove = function(event) {
                    if(player == null) return;
                    var dx = event.clientX-canvas.width/2;
                    var dy = event.clientY-canvas.height/2;
                    var speedScale = 0.005;
                    vel = {
                        x: dx*speedScale,
                        y: dy*speedScale
                    };
                };
                setInterval(function(){
                    ws.send(JSON.stringify(vel));
                }, 1000/60);
            };
            function moveFighters(){
                function move(fighter, dx, dy){
                    var x = fighter.x+dx;
                    var y = fighter.y+dy;
                    if(x < 0) return false;
                    if(y < 0) return false;
                    if(x >= level.length) return false;
                    if(y >= level[0].length) return false;
                    if(level[x][y] !== false) return false;
                    level[x][y] = fighter;
                    level[fighter.x][fighter.y] = false;
                    pixels[fighter.x+fighter.y*level.length] = 0;
                    fighter.x = x;
                    fighter.y = y;
                    pixels[fighter.x+fighter.y*level.length] = 255 << 24 | (0.5 + 0.8 * 255);
                    return true;
                }
                for(var i = 0; i < fighters.length; ++i){
                    var dir = shared.dist(level, areas, levelAreas, areaTargets, fighters[i]);
                    if(!dir) continue;
                    var m = Math.abs(dir.x)+Math.abs(dir.y);
                    if(m == 0) continue;
                    if(m == 1){
                        if(move(fighters[i], dir.x, dir.y)) continue;
                        var rand = (Math.random() < 0.5);
                        if(rand){
                            if(move(fighters[i], dir.x-dir.y, dir.x+dir.y)) continue;
                        }
                        else{
                            if(move(fighters[i], dir.x+dir.y, dir.y-dir.x)) continue;
                        }
                        rand = (Math.random() < 0.5);
                        if(rand){
                            if(move(fighters[i], -dir.y, dir.x)) continue;
                        }
                        else{
                            if(move(fighters[i], dir.y, -dir.x)) continue;
                        }
                    }
                    if(m == 2){
                        if(move(fighters[i], dir.x, dir.y)) continue;
                        var rand = (Math.random() < 0.5);
                        if(rand){
                            if(move(fighters[i], dir.x, 0)) continue;
                        }
                        else{
                            if(move(fighters[i], 0, dir.y)) continue;
                        }
                        rand = (Math.random() < 0.5);
                        if(rand){
                            if(move(fighters[i], -dir.y, dir.x)) continue;
                        }
                        else{
                            if(move(fighters[i], dir.y, -dir.x)) continue;
                        }
                    }
                }
            }
            function update(data){
                for(var i = 0; i < Object.keys(data.players).length; ++i){
                    var id = Object.keys(data.players)[i];
                    var p = data.players[id];
                    p.pos.x += p.vel.x;
                    p.pos.y += p.vel.y;
                    if(p.pos.x < 0) p.pos.x = 0;
                    if(p.pos.x > level.length) p.pos.x = level.length;
                    if(p.pos.y < 0) p.pos.y = 0;
                    if(p.pos.y > level[0].length) p.pos.y = level[0].length;
                    var pos = {
                        x: Math.min(Math.floor(p.pos.x), level.length-1),
                        y: Math.min(Math.floor(p.pos.y), level[0].length-1)
                    };
                    areaTargets = shared.search(level, areas, levelAreas, pos);
                }
                moveFighters();
            }
            function draw(data){
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.save()
                ctx.translate(canvas.width/2, canvas.height/2);
                var scale = 10;
                ctx.scale(scale, scale);
                ctx.translate(-player.pos.x, -player.pos.y);
                ctx.lineWidth = 0.1;
                for(var i = 0; i <= level.length; i += level.length){
                    ctx.beginPath();
                    ctx.moveTo(0, i);
                    ctx.lineTo(level.length, i);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(i, 0);
                    ctx.lineTo(i, level[0].length);
                    ctx.stroke();
                }
                ctx.lineWidth = 0.1;
                ctx.fillStyle = "black";
                offctx.clearRect(0, 0, off.width, off.height);
                offctx.putImageData(imagedata, 0, 0);
                ctx.drawImage(off, 0, 0, level.length, level[0].length);

                var radius = 1;
                for(var i = 0; i < Object.keys(data.players).length; ++i){
                    var p = data.players[Object.keys(data.players)[i]];
                    if(p.id == data.player.id) ctx.fillStyle = "green";
                    else ctx.fillStyle = "black";
                    ctx.beginPath();
                    ctx.arc(p.pos.x, p.pos.y, radius, 0, 2*Math.PI);
                    ctx.fill();
                }
                /*ctx.lineWidth = 0.3;
                ctx.strokeStyle = "blue";
                var p = {
                    x: Math.min(Math.floor(p.pos.x), level.length-1),
                    y: Math.min(Math.floor(p.pos.y), level[0].length-1)
                }
                //var i = levelAreas[p.x][p.y][0];
                for(var i = 0; i < areas.length; ++i){
                    ctx.strokeRect(areas[i].x1, areas[i].y1, areas[i].x2-areas[i].x1+1, areas[i].y2-areas[i].y1+1);
                    if(areaTargets[i].length == 0) continue;
                    ctx.fillRect(areaTargets[i][0].x, areaTargets[i][0].y, 2, 2);
                }*/
                ctx.restore();
            }
            ws.onmessage = function(event) {
                var data = JSON.parse(event.data);
                player = data.player;
                if(data.fighters){
                    fighters = data.fighters;
                    level = data.level;
                    [areas, levelAreas] = shared.computeAreas(level);
                    
                    off.width = level.length;
                    off.height = level[0].length;
                    offctx = off.getContext('2d');
                    imagedata = offctx.createImageData(level.length, level[0].length);
                    pixels = new Uint32Array(imagedata.data.buffer);
                    for(var i = 0; i < level.length; ++i){
                        for(var j = 0; j < level[0].length; ++j){
                            var r = 0;
                            var g = 0;
                            var b = 0;
                            if(level[i][j] === true) pixels[i+j*level.length] = ((255 << 8 | r) << 8 | g) << 8 | b;
                            else pixels[i+j*level.length] = 0;
                        }
                    }
                    for(var i = 0; i < fighters.length; ++i){
                        level[fighters[i].x][fighters[i].y] = fighters[i];
                    }
                    return;
                }
                update(data);
                draw(data);
            };
        </script>
    </body>
</html>